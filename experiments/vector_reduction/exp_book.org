#+title: Vector Reduction Experiments book
#+author: Henrique Silva
#+email: hcpsilva@inf.ufrgs.br
#+infojs_opt:
#+property: session *R*
#+property: cache yes
#+property: results graphics
#+property: exports both
#+property: tangle yes

It reduces a vector, that's it.

Preliminary library loading:

#+begin_src R :session :results none
library(DoE.base)
library(tidyverse)
#+end_src

* Table of contents                                                   :TOC_3:
- [[#1---the-basics][1 - The basics]]
  - [[#slurm-script][Slurm script]]
  - [[#scheduling][Scheduling]]

* 1 - The basics                                                        :EXP:

The test experiment.

#+begin_src R :session :results none
size = c("P", "M", "G")
nb = c("P", "M", "G")
fr = c("P", "M", "G")

fac.design (
    nfactors=3,
    replications=10,
    repeat.only=FALSE,
    blocks=1,
    randomize=TRUE,
    seed=10373,
    factor.names=list(
        Size=size,
        NumberOfBlocks=nb,
        ReductionFactor=fr)) %>%
  as_tibble %>%
  select(-Blocks) %>%
  write_csv("exp01/runs.csv")
#+end_src

Defined variables and names:

#+name: machines
#+begin_example
draco hype knl orion tupi
#+end_example

#+name: experiment_id
#+begin_example
exp01
#+end_example

** Slurm script

#+begin_src bash :tangle exp01/exp.slurm
#!/bin/bash
#SBATCH --time=02:00:00
#SBATCH --workdir=.
#SBATCH --output=%x_%j.out
#SBATCH --error=%x_%j.err

exec_name=${@[0]}
exec_id=${@[1]}

# prepare the machine file
machinefile="nodes.$SLURM_JOB_ID.$exec_name.$exec_id"

# compile the program
pushd $SCRATCH
mkdir $exec_name
cd $exec_name

# execute the program
#+end_src

** Scheduling

#+begin_src shell :var INPUT1=machines INPUT2=experiment_id
# i'm using org-src variable substitution
partitions=(INPUT1)

# to keep track on IDs
job_id=0

for name in "$partitions"; do
    nodes=$(gppd-info --long --Node -S NODELIST -p $name -h | awk '{print $1 "_" $7}' | paste -s -d" " -)

    for execution in "$nodes"; do
        # launch the slurm script for this node
        sbatch -w ${execution%%_*} INPUT2/exp.slurm $exec $job_id

        # increment execution id
        ((job_id++))
    done
done
#+end_src
